#!/bin/zsh

usage() {
    echo "memo r: recursively pick ONE memo and open with \`memo edit\`"
    exit 0
}

for arg in "$@"; do
    case $arg in
    -usage)
        usage
        ;;
    *)
        echo "Invalid option: $arg" 1>&2
        usage
        ;;
    esac
done

notes-fzf() {
    local root="${NOTES_DIR:-$HOME/notes}"
    local selected

    selected=$(
        fd -e md . "$root" |
            awk -v home="$HOME" '
        BEGIN { FS="/"; OFS="/" }
        {
            full=$0
            display=$0
            sub("^" home "/", "~", display)
            n=split(display, seg, "/")
            out=""
            for (i=1; i<=n; i++) {
                if (i==1 && seg[i]=="") { out="/"; continue }
                if (seg[i]=="~") { out = (out=="" ? "~" : out "/" "~"); continue }
                if (i>=n-1) { out = (out=="" ? seg[i] : out "/" seg[i]); continue }
                short = (length(seg[i])<=3 ? seg[i] : substr(seg[i],1,1))
                out = (out=="" ? short : out "/" short)
            }
            printf("%s\t%s\n", out, full)
        }
        ' |
            fzf-tmux -p 90%,90% \
                --ansi \
                --delimiter=$'\t' --with-nth=1 \
                --preview-window="right,65%" \
                --preview='cat {2}' \
                --bind 'enter:accept'
    )

    if [[ -n "$selected" ]]; then
        local filepath="${selected##*$'\t'}"
        $EDITOR "$filepath"
    fi
}

notes-fzf
