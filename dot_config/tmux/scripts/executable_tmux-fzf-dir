#!/usr/bin/env bash
# Usage: tmux-fzf-dir <source> <action>
# source: zoxide | ghq
# action: session | window | split-v | split-h

set -euo pipefail

source="${1:-}"
action="${2:-}"

if [[ -z "$source" || -z "$action" ]]; then
    echo "Usage: tmux-fzf-dir <source> <action>" >&2
    echo "  source: zoxide | ghq" >&2
    echo "  action: session | window | split-v | split-h" >&2
    exit 1
fi

# Common fzf options
fzf_opts="--bind=tab:down,shift-tab:up,btab:up --reverse --preview-window=down:40%"

# Select directory with fzf based on source
case "$source" in
zoxide)
    # Use zoxide score list with directory preview
    dir=$(zoxide query -ls | fzf $fzf_opts --preview "ls -la {2..}" | awk '{print $2}')
    ;;
ghq)
    short_path=$(ghq list | fzf $fzf_opts --preview "git -C \$(ghq list -p -e {}) log --oneline --graph --decorate --color=always -n 20")
    [[ -n "$short_path" ]] && dir=$(ghq list -p -e "$short_path") || dir=""
    ;;
*)
    echo "Unknown source: $source" >&2
    exit 1
    ;;
esac

# Exit if no directory selected
[[ -z "$dir" ]] && exit 0

# Execute action
case "$action" in
session)
    name=$(basename "$dir" | tr . _)
    if tmux has-session -t "$name" 2>/dev/null; then
        tmux switch-client -t "$name"
    else
        tmux new-session -d -s "$name" -c "$dir" && tmux switch-client -t "$name"
    fi
    ;;
window)
    tmux new-window -c "$dir"
    ;;
split-v)
    tmux split-window -v -c "$dir"
    ;;
split-h)
    tmux split-window -h -c "$dir"
    ;;
*)
    echo "Unknown action: $action" >&2
    exit 1
    ;;
esac
