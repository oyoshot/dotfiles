#!/bin/sh
set -euo pipefail

CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}"

# Install packages on Arch
{{ if eq .chezmoi.os "linux" }}
{{ if eq .chezmoi.osRelease.id "arch" }}
sudo pacman -Syu --noconfirm git binutils fakeroot make gcc base base-devel
if ! type yay > /dev/null 2>&1; then
    git clone https://aur.archlinux.org/yay.git
    cd yay
    makepkg -si --noconfirm
    cd
    rm -rf yay
fi

sed -e 's/[[:space:]]*#.*$//' -e '/^[[:space:]]*$/d' "$CONFIG_DIR/yay/extra-packages" \
    | xargs -r yay -S --needed --noconfirm --batchinstall --answerclean None --answerdiff None --answeredit None --removemake

orphans="$(pacman -Qqdt || true)"
if [ -n "$orphans" ]; then
    sudo pacman -Rs --noconfirm $orphans
fi
{{ end }}
{{ end }}
